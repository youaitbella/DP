<statements>
    <!-- Psy, 01.01.2020:
    Das Fachgebiet eines Hauses ist ein Status, bestimmt durch die letzte AEB Lieferung,
    also unabhÃ¤ngig vom jeweils auszuwertenden Datenjahres
    -->

    <statement id="KH_2_3_5_6_8_9">
        <![CDATA[
			select top 1 biId
            from psy.AEBBaseInformation bi
            where bi.biIk = {ik}
            and bi.biDataYear = {year}
            and bi.biStatusId = 10
			order by bi.biDataYear desc
        ]]>
    </statement>

    <statement id="KH_1_4_7">
        <![CDATA[
			select top 1 biId
            from psy.AEBBaseInformation bi
            where bi.biIk = {ik}
            and bi.biDataYear between {year} - 1 and {year}
            and bi.biStatusId = 10
			order by bi.biDataYear desc
        ]]>
    </statement>

    <statement id="Gruppe_2_3_8_9">
        <![CDATA[
            select biid
            from (
                select biid, cuik, actualPSyGroup, ROW_NUMBER() over (partition by biIk order by biDataYear desc) as rowNum
                from CallCenterDB.dbo.ccCustomer cu
                join (
                    -- select actualPsyGroup as PsyGroup for all years
                    select eh2.ehId, eh2.ehYear, eh2.ehIk, actualPSyGroup
                    from (
                        select ehIk, ehPsyGroup as actualPSyGroup
                        from (
                            select ehIk, ehPsyGroup, ROW_NUMBER() over (partition by ehik order by ehYear desc) as rown
                            from psy.ExpectedHospital eh1
                        ) a
                        where a.rown = 1
                    ) eh1
                    join psy.ExpectedHospital eh2 on eh2.ehIk = eh1.ehik
                ) eh on cuIk = ehIk
                join psy.AEBBaseInformation bi on cuIk = biik and ehYear = biDataYear
                where cuIsTest = 0
                    and cuIsActive = 1
                    and cuik not in (select hcexIk from psy.HospitalComparisonExcludeIK)
                    and case when cu.cuPsyStateId = 255 then cu.cuStateId else cu.cuPsyStateId end in ({stateIds})
                    and actualPSyGroup = {psyGroupId}
                    and bi.biDataYear = {year}
                    and bi.biStatusId = 10
            ) a
            where a.rowNum = 1
        ]]>
    </statement>

    <statement id="Gruppe_1_7">
        <![CDATA[
            select biid
            from (
                select biid, cuik, actualPSyGroup, ROW_NUMBER() over (partition by biIk order by biDataYear desc) as rowNum
                from CallCenterDB.dbo.ccCustomer cu
                join (
                    select eh2.ehId, eh2.ehYear, eh2.ehIk, actualPSyGroup
                    from (
                        select ehIk, ehPsyGroup as actualPSyGroup
                        from (
                            select ehIk, ehPsyGroup, ROW_NUMBER() over (partition by ehik order by ehYear desc) as rown
                            from psy.ExpectedHospital eh1
                        ) a
                        where a.rown = 1
                    ) eh1
                    join psy.ExpectedHospital eh2 on eh2.ehIk = eh1.ehik
                ) eh on cuIk = ehIk
                join psy.AEBBaseInformation bi on cuIk = biik and ehYear = biDataYear
                where cuIsTest = 0
                    and cuIsActive = 1
                    and cuik not in (select hcexIk from psy.HospitalComparisonExcludeIK)
                    and case when cu.cuPsyStateId = 255 then cu.cuStateId else cu.cuPsyStateId end in ({stateIds})
                    and actualPSyGroup = {psyGroupId}
                    and bi.biDataYear between {year} - 1 and {year}
                    and bi.biStatusId = 10
            ) a
            where a.rowNum = 1
        ]]>
    </statement>

    <statement id="Gruppe_5_6">
        <![CDATA[
        select bi.biId
        from psy.AEBBaseInformation bi
        where bi.biIk in (
                select cu.cuik
                from CallCenterDB.dbo.ccCustomer cu
                where cuIsTest = 0
                and cuIsActive = 1
                and cuik not in (select hcexIk from psy.HospitalComparisonExcludeIK)
				and case when cu.cuPsyStateId = 255 then cu.cuStateId else cu.cuPsyStateId end in ({stateIds})
        )
        and bi.biDataYear = {year}
        and bi.biStatusId = 10
        ]]>
    </statement>

    <statement id="Gruppe_4">
        <![CDATA[
            select biid
            from (
                select ROW_NUMBER() over (partition by bi.biIk order by bi.biDataYear desc) as rowNum, bi.biId
                from psy.AEBBaseInformation bi
                where bi.biIk in (
                    select cu.cuik
                    from CallCenterDB.dbo.ccCustomer cu
                    where cuIsTest = 0
                    and cuIsActive = 1
                    and cuik not in (select hcexIk from psy.HospitalComparisonExcludeIK)
					and case when cu.cuPsyStateId = 255 then cu.cuStateId else cu.cuPsyStateId end in ({stateIds})
                )
                and bi.biDataYear between {year} - 1 and {year}
                and bi.biStatusId = 10
            ) a
            where a.rowNum = 1
        ]]>
    </statement>

</statements>
