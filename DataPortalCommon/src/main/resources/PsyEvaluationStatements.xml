<statements>
    <!-- Psy, 01.01.2020:
    Das Fachgebiet eines Hauses ist ein Status, bestimmt durch die letzte AEB Lieferung,
    also unabhÃ¤ngig vom jeweils auszuwertenden Datenjahres
    -->

    <statement id="KH_2_3_5_6_8_9">
        <![CDATA[
			select top 1 biId
            from psy.AEBBaseInformation bi
            where bi.biIk = {ik}
            and bi.biDataYear = {year}
            and bi.biStatusId = 10
			order by bi.biDataYear desc
        ]]>
    </statement>

    <statement id="KH_1_4_7">
        <![CDATA[
			select top 1 biId
            from psy.AEBBaseInformation bi
            where bi.biIk = {ik}
            and bi.biDataYear between {year} - 1 and {year}
            and bi.biStatusId = 10
			order by bi.biDataYear desc
        ]]>
    </statement>

    <statement id="Gruppe_2_3_8_9">
        <![CDATA[
            select biId--, lastDelivered.biIk, PsyGroup.actPsyGroup, biDataYear
            from (
                -- last delivered psyGroup
                select lastAeb.biIk, ehPsyGroup as actPsyGroup
                from (
                    select biId, biIk, biDataYear as lastDataYear, ROW_NUMBER() over (partition by biIk order by biDataYear desc) as rown
                    from psy.AEBBaseInformation
                    where biStatusId = 10
                ) lastAeb
                join psy.ExpectedHospital eh on eh.ehIk = lastAeb.biIk and eh.ehYear = lastAeb.lastDataYear
                where rown = 1
            ) PsyGroup
            join (
                -- last delivered data
                select biId, biIk, biDataYear, biStatusId
                from (
                select biId, biIk, biDataYear, biStatusId, ROW_NUMBER() over (partition by biIk order by biDataYear desc) as rown
                from psy.AEBBaseInformation bi --on bi.biIk = actPsyGroup.biIk
                join psy.ExpectedHospital eh on eh.ehIk = bi.biIk and eh.ehYear = bi.biDataYear
                join CallCenterDB.dbo.ccCustomer cu on cu.cuIK = ehIk
                 where cuIsTest = 0
                        and cuIsActive = 1
                        and cuik not in (select hcexIk from psy.HospitalComparisonExcludeIK)
                        and case when cu.cuPsyStateId = 255 then cu.cuStateId else cu.cuPsyStateId end in ({stateIds})
                        and bi.biDataYear = {year}
                        and bi.biStatusId = 10
                ) data
                where rown = 1
            ) lastDelivered on lastDelivered.biIk = PsyGroup.biIk
            where
                PsyGroup.actPsyGroup = {psyGroupId}
        ]]>
    </statement>

    <statement id="Gruppe_1_7">
        <![CDATA[
            select biId--, lastDelivered.biIk, PsyGroup.actPsyGroup, biDataYear
            from (
                -- last delivered psyGroup
                select lastAeb.biIk, ehPsyGroup as actPsyGroup
                from (
                    select biId, biIk, biDataYear as lastDataYear, ROW_NUMBER() over (partition by biIk order by biDataYear desc) as rown
                    from psy.AEBBaseInformation
                    where biStatusId = 10
                ) lastAeb
                join psy.ExpectedHospital eh on eh.ehIk = lastAeb.biIk and eh.ehYear = lastAeb.lastDataYear
                where rown = 1
            ) PsyGroup
            join (
                -- last delivered data
                select biId, biIk, biDataYear, biStatusId
                from (
                select biId, biIk, biDataYear, biStatusId, ROW_NUMBER() over (partition by biIk order by biDataYear desc) as rown
                from psy.AEBBaseInformation bi --on bi.biIk = actPsyGroup.biIk
                join psy.ExpectedHospital eh on eh.ehIk = bi.biIk and eh.ehYear = bi.biDataYear
                join CallCenterDB.dbo.ccCustomer cu on cu.cuIK = ehIk
                 where cuIsTest = 0
                        and cuIsActive = 1
                        and cuik not in (select hcexIk from psy.HospitalComparisonExcludeIK)
                        and case when cu.cuPsyStateId = 255 then cu.cuStateId else cu.cuPsyStateId end in ({stateIds})
                        and bi.biDataYear between {year} - 1 and {year}
                        and bi.biStatusId = 10
                ) data
                where rown = 1
            ) lastDelivered on lastDelivered.biIk = PsyGroup.biIk
            where
                PsyGroup.actPsyGroup = {psyGroupId}
        ]]>
    </statement>

    <statement id="Gruppe_5_6">
        <![CDATA[
        select bi.biId
        from psy.AEBBaseInformation bi
        where bi.biIk in (
                select cu.cuik
                from CallCenterDB.dbo.ccCustomer cu
                where cuIsTest = 0
                and cuIsActive = 1
                and cuik not in (select hcexIk from psy.HospitalComparisonExcludeIK)
				and case when cu.cuPsyStateId = 255 then cu.cuStateId else cu.cuPsyStateId end in ({stateIds})
        )
        and bi.biDataYear = {year}
        and bi.biStatusId = 10
        ]]>
    </statement>

    <statement id="Gruppe_4">
        <![CDATA[
            select biid
            from (
                select ROW_NUMBER() over (partition by bi.biIk order by bi.biDataYear desc) as rowNum, bi.biId
                from psy.AEBBaseInformation bi
                where bi.biIk in (
                    select cu.cuik
                    from CallCenterDB.dbo.ccCustomer cu
                    where cuIsTest = 0
                    and cuIsActive = 1
                    and cuik not in (select hcexIk from psy.HospitalComparisonExcludeIK)
					and case when cu.cuPsyStateId = 255 then cu.cuStateId else cu.cuPsyStateId end in ({stateIds})
                )
                and bi.biDataYear between {year} - 1 and {year}
                and bi.biStatusId = 10
            ) a
            where a.rowNum = 1
        ]]>
    </statement>

</statements>
