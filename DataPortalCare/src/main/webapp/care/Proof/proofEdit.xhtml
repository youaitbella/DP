<?xml version='1.0' encoding='UTF-8' ?>

<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:jsf="http://xmlns.jcp.org/jsf"
                template="/WEB-INF/template.xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:inekIk="http://xmlns.jcp.org/jsf/composite/components/Other"
                xmlns:inekDialog="http://xmlns.jcp.org/jsf/composite/components/Dialog"
                xmlns:pf="http://primefaces.org/ui">


    <ui:define name="title">Nachweisvereinbarung</ui:define>

    <ui:define name="content">

        <script type="text/javascript">
            function start() {
                PF('dlgGeneratingData').show();
            }

            function stop() {
                PF('dlgGeneratingData').hide();
            }
        </script>

        <inekDialog:ProcessDialog varName="dlgLoadingData" headerText="Daten werden geladen"/>
        <inekDialog:ProcessDialog varName="dlgImportData" headerText="Daten werden importiert"/>
        <inekDialog:ProcessDialog varName="dlgGeneratingData" headerText="Daten werden generiert"/>

        <h:form id="form" onkeypress="if( event.keyCode == 13){event.keyCode=0;}">

            <div style="margin-top: 10px;">
                <pf:commandButton value="HiddenButton"
                                  style="display: none"
                                  immediate="true"/>

                <pf:commandButton value="Zurück zur Übersicht"
                                  icon="fa fa-arrow-left"
                                  action="#{proofEdit.navigateToSummary()}"
                                  onclick="PF('navigationDialog').show();"
                                  immediate="true"/>

                <pf:button target="blank"
                           value="Hilfe?"
                           icon="fa fa-info"
                           href="https://www.g-drg.de/Pflegepersonaluntergrenzen/Umsetzung_der_Verordnung_zur_Festlegung_von_Pflegepersonaluntergrenzen_in_pflegesensitiven_Bereichen_in_Krankenhaeusern_PpUGV/FAQ"/>
            </div>

            <div class="ui-g">
                <div class="card" style="min-width: 500px;">
                    <div class="ui-g-12" jsf:rendered="#{proofEdit.proofRegulationBaseInformation.id lt 0}">

                        <pf:panel header="IK Auswahl">
                            <inekIk:MultiIk_V2 label="#{msg.lblIkShort}"
                                               value="#{proofEdit.proofRegulationBaseInformation.ik}"
                                               ikList="#{proofEdit.validIks}"
                                               listener="#{proofEdit.ikChanged()}"
                                               updateElement="form"/>
                        </pf:panel>

                        <pf:panel header="Auswahl des Jahres">
                            <h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
                                <pf:outputLabel for="selectYear" value="Jahr:"/>

                                <pf:selectOneMenu id="selectYear"
                                                  title="Jahr"
                                                  required="true"
                                                  requiredMessage="Bitte ein Jahr auswählen"
                                                  value="#{proofEdit.proofRegulationBaseInformation.year}">
                                    <f:selectItem
                                            rendered="#{proofEdit.proofRegulationBaseInformation.year eq 0}"
                                            itemLabel="#{msg.lblChooseEntryShort}" itemValue="#{0}"
                                            noSelectionOption="true"/>
                                    <f:selectItems value="#{proofEdit.validYears}"/>
                                    <pf:ajax event="change" listener="#{proofEdit.validYearsChanged()}"
                                             update="selectQuarter msgselectYear"/>
                                </pf:selectOneMenu>
                            </h:panelGrid>
                            <pf:message for="selectYear" id="msgselectYear"/>
                        </pf:panel>

                        <pf:panel header="Quartal Auswahl">
                            <h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
                                <pf:outputLabel for="selectQuarter" value="Quartal:"/>

                                <pf:selectOneMenu id="selectQuarter"
                                                  title="Quartal"
                                                  required="true"
                                                  requiredMessage="Bitte ein Quartal auswählen"
                                                  value="#{proofEdit.proofRegulationBaseInformation.quarter}">
                                    <f:selectItem
                                            rendered="#{proofEdit.proofRegulationBaseInformation.quarter eq 0}"
                                            itemLabel="#{msg.lblChooseEntryShort}" itemValue="#{0}"
                                            noSelectionOption="true"/>
                                    <f:selectItems value="#{proofEdit.validQuarters}" var="quarter"
                                                   itemLabel="Quartal #{quarter}"/>
                                </pf:selectOneMenu>
                            </h:panelGrid>
                            <pf:message for="selectQuarter" id="msgselectQuarter"/>

                            <pf:commandButton value="Daten erfassen"
                                              onclick="PF('dlgLoadingData').show()"
                                              oncomplete="PF('dlgLoadingData').hide()"
                                              action="#{proofEdit.firstSave()}"
                                              style="margin-left: 10px;"
                                              update="@form"/>
                        </pf:panel>

                    </div>

                    <div class="ui-g-12" jsf:rendered="#{proofEdit.proofRegulationBaseInformation.id gt 0}">
                        <h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5"
                                     rendered="#{proofEdit.proofRegulationBaseInformation.id gt 0}">
                            <pf:outputLabel value="IK:"/>
                            <pf:outputLabel value="#{proofEdit.proofRegulationBaseInformation.ik}"/>
                            <pf:outputLabel value="Jahr:"/>
                            <pf:outputLabel value="#{proofEdit.proofRegulationBaseInformation.year}"/>
                            <pf:outputLabel value="Quartal:"/>
                            <pf:outputLabel value="Q#{proofEdit.proofRegulationBaseInformation.quarter}"/>
                            <pf:outputLabel value="Signatur:"/>
                            <pf:outputLabel value="#{proofEdit.proofRegulationBaseInformation.signature}"/>
                        </h:panelGrid>

                    </div>

                </div>
            </div>


            <div class="ui-g"
                 jsf:rendered="#{proofEdit.proofRegulationBaseInformation.id gt 0 and !proofEdit.isReadOnly}">
                <div class="card" style="min-width: 800px;">
                    <div class="ui-g-12">
                        <inekDialog:ProcessDialog varName="dlgImportData" headerText="Daten werden importiert"/>

                        <h1>Excelimport</h1>

                        <pf:commandButton value="Vorlage herunterladen (Excel)"
                                          ajax="false"
                                          onclick="PrimeFaces.monitorDownload(start, stop);"
                                          icon="ui-icon-arrowthick-1-s">
                            <pf:fileDownload value="#{proofEdit.downloadExcelTemplate()}"/>
                        </pf:commandButton>

                        <br/>
                        <br/>

                        <pf:fileUpload fileUploadListener="#{proofEdit.handleFileUpload}"
                                       mode="advanced"
                                       onstart="PF('dlgImportData').show()"
                                       oncomplete="PF('dlgImportData').hide()"
                                       fileLimit="1"
                                       fileLimitMessage="Es darf nur eine Datei hochgeladen werden"
                                       invalidFileMessage="Es dürfen nur Excel (.xlsx oder .xls) Dateien hochgeladen werden"
                                       allowTypes="/(\.|\/)(xlsx|xls)$/"
                                       auto="true"
                                       cancelLabel="Abbrechen"
                                       uploadLabel="Datei Hochladen"
                                       label="Exceldatei auswählen"
                                       update="@form"/>

                        <pf:inputTextarea value="#{proofEdit.uploadMessage}"
                                          rendered="#{proofEdit.uploadMessage.length() gt 0}"
                                          style="width: 100%"/>

                    </div>
                </div>
            </div>

            <div class="ui-g" jsf:rendered="#{proofEdit.proofRegulationBaseInformation.id gt 0}">
                <div class="card">
                    <div class="ui-g-12">

                        <pf:messages id="errorMessages"
                                     showDetail="true">
                        </pf:messages>

                        <div style="text-align: justify; border: 1px solid #ffa727; padding: 10px;">
                            <pf:fieldset legend="Ausfüllhinweise"
                                         style="border: none"
                                         toggleable="true"
                                         toggleSpeed="500"
                                         collapsed="true">
                                <b>Zu pflegesensitiver Bereich, Fachabteilung(sschlüssel), Standort, Station, Monat, Schicht</b>
                                <p>Die relevanten Informationen werden Ihren Angaben aus der Meldung gem. § 5 PpUGV entnommen. Ggf. bis zum 15.01.2019 im Datenportal eingetragene strukturelle Veränderungen (§ 5 Abs. 4 PpUGV) wurden berücksichtigt. >Diese Angaben werden im Datenportal automatisch für Sie eingetragen und können nicht geändert werden. Die Monatsnamen sowie die alternierende Differenzierung der Schichten (Tag/Nacht) werden durch das Datenportal ebenfalls vorbelegt. Für diese vom Datenportal vorbelegten Stationen und Schichten sind im ausgewählten Quartal Angaben einzutragen.</p>
                                <b>Zu Anzahl Schichten Summe</b>
                                <p>Die Anzahl der Schichten eines Monats entspricht typischerweise der Anzahl der Kalendertage eines Monats. Den entsprechenden Wert (z.B. 31 für Januar) haben wir bereits im Datenportal hinterlegt. Bei Bedarf kann die Anzahl der Schichten eines Monats angepasst werden (beispielsweise weil die Station zu bestimmten Schichten in dem Monat geschlossen war).</p>
                                <b>Zu durchschnittliche Pflegepersonalausstattung</b>
                                <p>Die durchschnittliche Pflegepersonalausstattung mit Pflegekräften ist differenziert nach Pflegefachkräften gem. § 2 Abs. 1 S. 2 PpUGV und Pflegehilfskräften gem. § 2 Abs. 1 S. 3 PpUGV anzugeben. Die Pflegepersonalausstattung wird anhand der geleisteten Arbeitsstunden ermittelt; entsprechend sind aus der Personaldokumentation die täglich geleisteten Arbeitsstunden in der Differenzierung nach Pflegefachkräften und Pflegehilfskräften auszuleiten. Die Personalplanung ist nicht nach den Schichten gem. § 2 Abs. 2 PpUGV auszurichten. Lediglich die Zuordnung der geleisteten Arbeitsstunden der Pflegekräfte erfolgt nach den Schichtgrenzen der PpUGV. Die Schichtgrenzen der PpUGV dienen der Vereinheitlichung zur besseren Vergleichbarkeit. Wenn Pflegekräfte in einem Schichtmodell arbeiten, das nicht den Schichtgrenzen der PpUGV folgt, sind die an einem Arbeitstag geleisteten Arbeitsstunden ggf. anteilig den beiden Schichten (Tag/Nacht) zuzuordnen (§ 3 Abs. 3 PpUG-Nachweis-Vereinbarung). Die durchschnittliche Pflegepersonalausstattung ergibt sich aus der Summe der pro Schicht geleisteten Arbeitsstunden eines Kalendermonats geteilt durch die Anzahl der Stunden der Schichten des Kalendermonats.</p>
                                <b>Zu durchschnittliche Patientenbelegung</b>
                                <p>Die durchschnittliche Patientenbelegung ist täglich anhand des Mitternachtsbestandes zu ermitteln. Der für einen Tag ermittelte Mitternachtsbestand gilt für die laufende Nacht-Schicht und die darauffolgende Tag-Schicht als Patientenbelegung. Die durchschnittliche Patientenbelegung eines Monats ergibt sich aus der Summe der Mitternachtsbestände der jeweiligen Station geteilt durch die Anzahl der Kalendertage des jeweiligen Monats (§ 3 Abs. 4 PpUG-Nachweis-Vereinbarung).</p>
                                <b>Zu Anzahl Schichten, in denen die PPUG nicht eingehalten wurde</b>
                                <p>In diesem Feld ist die Anzahl der Schichten einzutragen, in denen im Monat die Pflegepersonaluntergrenzen nicht eingehalten wurden. Die Angaben erfolgen getrennt für die Tag- und die Nacht-Schicht. Entsprechend ist vom Krankenhaus täglich differenziert nach Tag-/Nacht-Schicht festzustellen, ob die Pflegepersonaluntergrenze eingehalten wurde.</p>
                                <b>Zu rechnerische Anzahl Patienten je Pflegekraft</b>
                                <p>Die rechnerische Anzahl von Patienten je Pflegekraft wird aus den Angaben der vorhergehenden Spalten berechnet und automatisch angezeigt. Die Angabe kann nicht geändert werden. Bei der Berechnung wird berücksichtigt, dass gem. § 6 Abs. 2 PpUGV nur ein bestimmter Anteil an Pflegehilfskräften für die Überprüfung der Einhaltung der Pflegepersonaluntergrenzen angerechnet werden kann (siehe auch Anlage 1 zur PpUG-Nachweis-Vereinbarung). Ist die rechnerische Anzahl von Patienten je Pflegekraft größer als die Pflegepersonaluntergrenze des entsprechenden pflegesensitiven Bereichs wird die Anzahl in roter Schrift angezeigt. Damit wird verdeutlicht, dass die Pflegepersonaluntergrenze für diesen pflegesensitiven Bereich für die entsprechende Tag- bzw. Nacht-Schicht im Monatsdurchschnitt nicht eingehalten wurde.</p>
                                <b>Zu Anzahl Pflegehilfskräfte anrechenbar für PPUG</b>
                                <p>In diesem Feld wird angegeben, wie hoch die Anzahl von Pflegehilfskräften ist, die für die Einhaltung der Pflegepersonaluntergrenzen angerechnet werden kann. Diese Zahl wird aus der Anzahl der Pflegefachkräfte und den Vorgaben in § 6 PpUGV berechnet. Die von Ihnen eingegebene durchschnittliche Anzahl Pflegehilfskräfte kann von der Anzahl der anrechenbaren Pflegehilfskräfte sowohl nach oben als auch nach unten abweichen. Der Wert wird automatisch berechnet und kann nicht geändert werden.</p>
                                <b>Zu "Neuen Ausnahmetatbestand hinzufügen"</b>
                                <p>Für die Jahresmeldung zum 30.06. des Folgejahres können Sie bei Nichteinhaltung der Pflegepersonaluntergrenzen ggf. Ausnahmetatbestände wie kurzfristige über das übliche Maß hinausgehende krankheitsbedingte Personalausfälle (§ 8 Abs. 2 Nr. 1 PpUGV), starke Erhöhung der Patientenzahl (Epidemie, Großschadensereignis, § 8 Abs. 2 Nr. 2 PpUGV) oder ggf. in der PpUG-Sanktionsvereinbarung weitere genannte Ausnahmetatbestände geltend machen. Dazu können Sie bereits unterjährig für den betroffenen pflegesensitiven Bereich eine entsprechende Eingabe hinterlegen (Ausnahmetatbestand und zusätzliche Erläuterung).</p>
                            </pf:fieldset>
                            <p>Bei Fragen konsultieren Sie bitte den Text der Rechtsverordnung sowie die auf unserer Internetseite bereitgestellte
                                <a href="https://www.g-drg.de/Pflegepersonaluntergrenzen/Umsetzung_der_Verordnung_zur_Festlegung_von_Pflegepersonaluntergrenzen_in_pflegesensitiven_Bereichen_in_Krankenhaeusern_PpUGV/FAQ"
                                   target="_blank">FAQ-Liste</a>. Bei darüber hinaus gehenden Fragestellungen können Sie sich gerne an das InEK wenden (per E-Mail:
                                <a href="mailto:PPUGV-Umsetzung@inek-drg.de">PPUGV-Umsetzung@inek-drg.de</a> bzw. per Telefon: (02241) 93 82 500).
                            </p>
                        </div>
                    </div>
                    <div class="ui-g-12">
                        <ui:include src="proof.xhtml"/>
                    </div>
                </div>
            </div>

            <div class="ui-g" jsf:rendered="#{proofEdit.proofRegulationBaseInformation.id gt 0}">
                <div class="card">
                    <div class="ui-g-12" jsf:id="buttons">
                        <div>
                            <pf:commandButton value="Datensatz ändern (inkl. Daten und neue Signatur)"
                                              action="#{proofEdit.change()}"
                                              rendered="#{proofEdit.changeAllowed() and not proofEdit.isExceptionFactsChangeMode}"
                                              style="margin-left: 10px;"
                                              update="@(.ui-message) @form">
                                <pf:confirm header="Daten wirklich ändern?" message="Durch diesen Vorgang wird die bestehende Signatur ungültig.
                            Beim erneuten abschließenden Senden wird aus den Daten eine dann gültige Signatur berechnet."/>
                            </pf:commandButton>

                            <pf:commandButton value="Quartalsmeldung exportieren (Excel)"
                                              ajax="false"
                                              rendered="#{proofEdit.excelExportAllowed()}"
                                              style="margin-left: 10px;"
                                              onclick="PrimeFaces.monitorDownload(start, stop);"
                                              icon="ui-icon-arrowthick-1-s">
                                <pf:fileDownload value="#{proofEdit.exportQuarterAsExcel()}"/>
                            </pf:commandButton>

                            <pf:commandButton value="Jahresmeldung exportieren (Excel)"
                                              ajax="false"
                                              rendered="#{proofEdit.annualReportAllowed()}"
                                              style="margin-left: 10px;"
                                              onclick="PrimeFaces.monitorDownload(start, stop);"
                                              icon="ui-icon-arrowthick-1-s">
                                <pf:fileDownload value="#{proofEdit.exportAnnualReportAsExcel()}"/>
                            </pf:commandButton>

                            <pf:commandButton
                                    value="Ausnahmetatbestände ändern (Sonstige Daten und Signatur bleiben erhalten)"
                                    action="#{proofEdit.changeExceptionsFacts()}"
                                    rendered="#{proofEdit.changeAllowed() and not proofEdit.isExceptionFactsChangeMode}"
                                    style="margin-left: 10px;"
                                    update="@(.ui-message) @form"/>

                            <pf:commandButton value="Geänderte Ausnahmetatbestände speichern"
                                              action="#{proofEdit.saveChangedExceptionFacts()}"
                                              onstart="PF('dlgLoadingData').show()"
                                              oncomplete="PF('dlgLoadingData').hide()"
                                              rendered="#{proofEdit.isExceptionFactsChangeMode}"
                                              style="margin-left: 10px;"
                                              update="@(.ui-message) @form"/>

                            <pf:commandButton value="Speichern ohne Senden"
                                              action="#{proofEdit.save()}"
                                              onstart="PF('dlgLoadingData').show()"
                                              oncomplete="PF('dlgLoadingData').hide()"
                                              rendered="#{!proofEdit.isReadOnly}"
                                              style="margin-left: 10px;"
                                              update="@(.ui-message) @form"/>

                            <pf:commandButton value="Meldung abschließend ans InEK senden"
                                              action="#{proofEdit.send()}"
                                              onstart="PF('dlgLoadingData').show()"
                                              oncomplete="PF('dlgLoadingData').hide()"
                                              rendered="#{!proofEdit.isReadOnly and proofEdit.sendAllowed()}"
                                              disabled="#{not proofEdit.sendAllowedForToday()}"
                                              styleClass="green-button"
                                              style="margin-left: 10px;"
                                              icon="fa fa-arrow-right"
                                              iconPos="right"
                                              update="@(.ui-message) @form"/>

                            <pf:commandButton value="Fristverlängerung anfordern"
                                              action="#{proofEdit.requestExtension()}"
                                              onstart="PF('dlgLoadingData').show()"
                                              oncomplete="PF('dlgLoadingData').hide()"
                                              rendered="#{!proofEdit.isReadOnly and proofEdit.requestExtensionAllowed}"
                                              style="margin-left: 10px;"
                                              update="@(.ui-message) :form:buttons"/>
                        </div>
                        <br/>
                        <div jsf:id="fileName" class="inputPart marginTop01em"
                             jsf:rendered="#{not empty proofEdit.documentName
                                                 and proofEdit.isReadOnly
                                                 and proofEdit.annualReportAllowed()}">
                            <h:outputLabel value="Anlage:" styleClass="label element08em"/>
                            <h:commandLink
                                    action="#{proofEdit.downloadDocument()}"
                                    value="#{proofEdit.documentName}"
                                    immediate="true">
                            </h:commandLink>

                        </div>
                        <br/>
                        <pf:fileUpload fileUploadListener="#{proofEdit.uploadDocument}"
                                       mode="advanced"
                                       auto="true"
                                       fileLimit="1"
                                       fileLimitMessage="Es darf nur eine Datei hochgeladen werden"
                                       invalidFileMessage="Es dürfen nur PDF oder Bilddateien (JPG, JPEG, PNG, BMP, GIF ) hochgeladen werden"
                                       allowTypes="/(\.|\/)(pdf|jpg|jpeg|png|bmp|gif)$/"
                                       cancelLabel="Abbrechen"
                                       uploadLabel="Datei Hochladen"
                                       label="Unterschriebene Anlage auswählen"
                                       rendered="#{proofEdit.annualReportAllowed()}"
                                       update="@form"/>

                        <pf:outputLabel
                                rendered="#{not proofEdit.sendAllowedForToday() and proofEdit.proofRegulationBaseInformation.status.id lt 10}"
                                style="padding-left: 10px"
                                value="Die Daten können erst am Ende des Quartals ans InEK gesendet werden"/>
                    </div>
                </div>
            </div>
        </h:form>
    </ui:define>
</ui:composition>

